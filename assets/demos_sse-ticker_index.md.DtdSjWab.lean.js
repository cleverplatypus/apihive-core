import{C as L,c as R,a as o,b as T,H as _}from"./chunks/HTTPRequestFactory.B_LA8_EG.js";import{a1 as P,d as I,p as U,c as p,o as E,j as n,G as f,e as y,k,t as A,F as b,B as x,_ as M,C as N,a3 as O,a as H,w as j}from"./chunks/framework.DJIHrpKd.js";import{I as z}from"./chunks/InlineMessage.DZU86agj.js";class V{constructor(i){var s;this._abortController=new AbortController,this.logger=new L,this.wasUsed=!1,this.interceptors=[],this.wrapErrors=!1,this.config={templateURLHistory:[i.url],urlParams:{},queryParams:{},timeout:0,logLevel:"error",meta:{},responseBodyTransformers:[],sseListeners:[],errorInterceptors:[]},this.wrapErrors=!!i.wrapErrors,(s=i.defaultConfigBuilders)==null||s.forEach(a=>a(this))}withSSEListeners(...i){return this.config.sseListeners.push(...i),this}withURLParam(i,s){return this.config.urlParams[i]=s,this}withURLParams(i){return Object.assign(this.config.urlParams,i),this}withQueryParam(i,s){return this.config.queryParams[i]=s,this}withQueryParams(i){return Object.assign(this.config.queryParams,i),this}withTimeout(i){return this.config.timeout=i,this}withLogLevel(i){return this.config.logLevel=i,this}withMeta(i,s){return typeof i=="string"?this.config.meta[i]=s:Object.assign(this.config.meta,i),this}withResponseBodyTransformers(...i){return this.config.responseBodyTransformers.push(...i),this}withRequestInterceptors(...i){return this.interceptors.push(...i),this}withErrorInterceptors(...i){return this.config.errorInterceptors.push(...i),this}get abortController(){return this._abortController}isFinalized(){return typeof this.finalizedURL=="string"}composeURL(){return R({templateURLHistory:this.config.templateURLHistory,urlParams:this.config.urlParams,queryParams:this.config.queryParams,config:this.config})}getLogger(){return this.logger.withMinimumLevel(this.config.logLevel)}withLogger(i){return this.logger=i,this}createInterceptorControls(){return{abort:()=>{clearTimeout(this.timeoutId),this._abortController.abort()},replaceURL:(i,s)=>{if(this.isFinalized())throw new Error("The request has already been finalised.");this.config.templateURLHistory.push(i),s&&(this.config.urlParams=s)},getProvisionalURL:()=>this.composeURL(),finaliseURL:()=>(this.isFinalized()||(this.finalizedURL=this.composeURL()),this.finalizedURL),updateQueryParams:i=>{Object.assign(this.config.queryParams,i)}}}async execute(){if(this.wasUsed)throw new Error("SSERequest cannot be reused. Create a new one each time.");this.wasUsed=!0;const i=this.createInterceptorControls();for(const h of this.interceptors)if(await h({...this.config},i)!==void 0)return{close(){}};this.finalizedURL=this.composeURL(),this.config.timeout&&(this.timeoutId=setTimeout(()=>{this.getLogger().debug("SSERequest : connection timeout",`Timeout after ${this.config.timeout} ms`),this._abortController.abort()},this.config.timeout)),this._abortController.signal.addEventListener("abort",async()=>{const h=new o(-1,"Request aborted");for(const l of this.config.errorInterceptors)if(await l(h))break},{once:!0});let s=null,a=!1,e,c;const S=new Promise((h,l)=>{e=h,c=l});try{const h=globalThis.EventSource;if(!h)throw new Error("EventSource is not available in the current environment");s=new h(this.finalizedURL)}catch(h){clearTimeout(this.timeoutId);const l=new o(-1,"Failed to open SSE connection",h);for(const r of this.config.errorInterceptors)try{if(await r(l))break}catch{}return this.wrapErrors?{error:l}:Promise.reject(l)}const F=()=>{a=!0,e()},u=async h=>{const l=new o(-1,"SSE connection error",h);for(const r of this.config.errorInterceptors)if(await r(l))break;try{c(l)}catch{}},C=async h=>{const l=h.data;let r=l;if(typeof l=="string")try{r=JSON.parse(l)}catch{this.getLogger().debug("SSERequest : received non-JSON data",l)}try{const B=await T(r,{responseBodyTransformers:this.config.responseBodyTransformers});for(const v of this.config.sseListeners)try{v(B)}catch(q){this.getLogger().warn("SSE listener error",q)}}catch(B){this.getLogger().warn("SSERequest : transformer error",B)}};s.addEventListener("open",F),s.addEventListener("error",u),s.addEventListener("message",C);const m=()=>{try{if(!a){const h=new o(-1,"Request aborted");try{c(h)}catch{}}s==null||s.close()}catch{}};this._abortController.signal.addEventListener("abort",m,{once:!0});try{await S}catch(h){clearTimeout(this.timeoutId);try{this._abortController.signal.removeEventListener("abort",m),s==null||s.removeEventListener("open",F),s==null||s.removeEventListener("error",u),s==null||s.removeEventListener("message",C),s==null||s.close()}catch{}return s=null,this.wrapErrors?{error:h}:Promise.reject(h)}clearTimeout(this.timeoutId);const D={close:()=>{try{this._abortController.signal.removeEventListener("abort",m),s==null||s.removeEventListener("open",F),s==null||s.removeEventListener("error",u),s==null||s.removeEventListener("message",C),s==null||s.close()}catch{}s=null},getEventSource:()=>s};return this.wrapErrors?{subscription:D}:D}}class Q{constructor(){this.name="sse-request"}getDelegates(i){return{factory:{createSSERequest:(s,{defaultConfigBuilders:a,wrapErrors:e})=>new V({url:s,defaultConfigBuilders:a,wrapErrors:e})}}}}const t=P({updates:[],connectionState:"disconnected",error:""}),w={name:"default",baseURL:"https://stream.wikimedia.org/v2/stream",endpoints:{updates:{method:"SSE",target:"/recentchange"}}};class G{constructor(){this.factory=new _().use(new Q).withWrappedResponseError().withAPIConfig(w)}onDisconnect(i){this.factory.withErrorInterceptors(s=>(i(s.message),!1))}async start(){t.connectionState="connecting";const{subscription:i,error:s}=await this.factory.withAPIConfig(w).createSSEAPIRequest("updates").withErrorInterceptors(()=>(t.connectionState="disconnected",!1)).withSSEListeners(a=>{t.updates.unshift(a),t.updates.length>10&&t.updates.splice(10)}).execute();if(s){t.error=s.message;return}this.subscription=i,t.connectionState="connected"}stop(){this.subscription.close(),t.connectionState="disconnected"}}const d=new G,W={class:"sse-ticker-demo pico demo"},J={class:"top-bar"},$={class:"buttons"},K=["disabled","aria-busy"],X={class:"outline secondary",disabled:""},Y={key:0,class:"striped"},Z={class:"truncate"},ss=I({__name:"SSETickerDemo",setup(g){const i=U(null);return d.onDisconnect(s=>{i.value.show("error",s)}),(s,a)=>(E(),p("article",W,[n("div",J,[n("div",$,[["disconnected","connecting"].includes(k(t).connectionState)||!k(t).updates.length&&k(t).connectionState==="connected"?(E(),p("button",{key:0,disabled:k(t).connectionState!=="disconnected","aria-busy":k(t).connectionState==="connecting"||k(t).connectionState==="connected"&&!k(t).updates.length,onClick:a[0]||(a[0]=(...e)=>k(d).start&&k(d).start(...e))}," Start Receiving Updates ",8,K)):y("",!0),k(t).connectionState==="connected"?(E(),p("button",{key:1,class:"secondary",onClick:a[1]||(a[1]=(...e)=>k(d).stop&&k(d).stop(...e))},"Stop")):y("",!0)]),n("button",X,"Status: "+A(k(t).connectionState),1)]),f(z,{ref_key:"inlineMessage",ref:i},null,512),k(t).updates.length?(E(),p(b,{key:0},[a[4]||(a[4]=n("hr",null,null,-1)),k(t).updates.length?(E(),p("table",Y,[a[2]||(a[2]=n("colgroup",null,[n("col",{style:{width:"auto"}}),n("col",{style:{width:"1%"}})],-1)),a[3]||(a[3]=n("thead",null,[n("tr",null,[n("th",null,[n("span",{class:"truncate"},"Title")]),n("th",null,"Timestamp")])],-1)),n("tbody",null,[(E(!0),p(b,null,x(k(t).updates,e=>(E(),p("tr",{key:e.id},[n("td",null,[n("span",Z,A(e.title),1)]),n("td",null,A(e.timestamp),1)]))),128))])])):y("",!0)],64)):y("",!0)]))}}),is=M(ss,[["__scopeId","data-v-be00a822"]]),ls=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"demos/sse-ticker/index.md","filePath":"demos/sse-ticker/index.md"}'),as={name:"demos/sse-ticker/index.md"},ks=Object.assign(as,{setup(g){return(i,s)=>{const a=N("ClientOnly");return E(),p("div",null,[s[0]||(s[0]=n("h2",{id:"demo-sse-ticker",tabindex:"-1"},[H("Demo: SSE Ticker "),n("a",{class:"header-anchor",href:"#demo-sse-ticker","aria-label":'Permalink to "Demo: SSE Ticker"'},"â€‹")],-1)),s[1]||(s[1]=n("p",null,"This demo shows how to use SSE to implement a simple update ticker.",-1)),s[2]||(s[2]=n("p",null,"It connects to wikipedia's public SSE endpoint and displays the latest 10 updates in a ticker.",-1)),f(a,null,{default:j(()=>[f(is)]),_:1}),s[3]||(s[3]=O("",2))])}}});export{ls as __pageData,ks as default};
