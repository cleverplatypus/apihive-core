import{H as U}from"./chunks/HTTPRequestFactory.B_LA8_EG.js";import{I as M}from"./chunks/InlineMessage.DZU86agj.js";import{a1 as I,d as H,p as D,c,o as u,j as l,e as f,G as m,k as E,t as N,a as b,C as R,a3 as O,w as S}from"./chunks/framework.DJIHrpKd.js";const i=I({invocations:0,progress:-1,file:null});function X(y,h){const a=(y.progressHandlers||[]).filter(t=>t.upload);return a.length===0?(t,n)=>globalThis.fetch(t,n):function(t,n){return typeof XMLHttpRequest>"u"?(h.logger.warn("Upload progress feature requires XMLHttpRequest"),globalThis.fetch(t,n)):new Promise((A,F)=>{const s=new XMLHttpRequest;if(s.open((n==null?void 0:n.method)||"GET",t,!0),s.responseType="arraybuffer",n!=null&&n.headers){const k=n.headers;if(k instanceof Headers)k.forEach((p,r)=>s.setRequestHeader(r,p));else if(Array.isArray(k))for(const[p,r]of k)s.setRequestHeader(p,String(r));else for(const p of Object.keys(k))s.setRequestHeader(p,String(k[p]))}const e=n==null?void 0:n.signal,B=()=>{try{s.abort()}catch{}};e&&(e.aborted?B():e.addEventListener("abort",B,{once:!0}));const v=new WeakMap;s.upload.onprogress=k=>{const p=k,r=p.loaded??0,d=p.total,g=p.lengthComputable??!1,C=g&&d?Math.min(100,Math.floor(r/d*100)):0;for(const o of a){let q=!1;const w=o.throttleMs??0,_=Date.now(),T=v.get(o.upload),x=C===100||g&&d!=null&&r>=d;if(!(w>0&&T&&_-T<w)||x){v.set(o.upload,_);try{o.upload({phase:"upload",percentProgress:C,loadedBytes:r,totalBytes:g?d:void 0,requestConfig:y,fallThrough:()=>{q=!0}})}catch{h.logger.warn("Upload progress handler failed")}}if(!q)break}},s.onload=()=>{const k=new Headers,p=s.getAllResponseHeaders();p&&p.trim().split(/\r?\n/).forEach(d=>{const g=d.indexOf(":");if(g>0){const C=d.slice(0,g).trim(),o=d.slice(g+1).trim();k.append(C,o)}});const r=s.response!=null?new Blob([s.response]):null;A(new Response(r,{status:s.status,statusText:s.statusText,headers:k}))},s.onerror=()=>F(new TypeError("Network request failed")),s.ontimeout=()=>F(new TypeError("Network request timed out"));try{s.send(n==null?void 0:n.body)}catch(k){F(k)}})}}class L{constructor(){this.name="upload-progress"}getDelegates(h){return{request:{getFetchImpl:a=>X(a,h)}}}}class V{constructor(){this.abortController=null,this.requestFactory=new U().use(new L)}onFileChange(h){i.file=h,i.invocations=0,i.progress=-1}uploadFile(){i.invocations=0,i.progress=0;const h=this.requestFactory.createPOSTRequest("https://httpbin.org/anything").withFormDataBody(a=>{a.append("file",i.file)}).withProgressHandlers({upload:a=>{i.progress=a.percentProgress,i.invocations++},throttleMs:10}).withAbortListener(()=>{i.progress=-1,this.abortController=null});return h.execute(),()=>h.abortController.abort()}}const P=new V,K={class:"demo"},j={"action.prevent":"",class:"pico"},Q={style:{display:"flex",gap:"1rem","justify-content":"space-between","align-items":"center"}},G=["disabled"],Z={style:{display:"flex",gap:"1rem"}},$=["disabled"],J=["value"],W=H({__name:"FileUploadProgress",setup(y){const h=D(null);D(null);const a=D(null);let t=null;const n=()=>{var s,e;P.onFileChange((e=(s=h.value)==null?void 0:s.files)==null?void 0:e[0])},A=()=>{t(),a.value.show("warn","Upload aborted"),t=null},F=()=>{t=P.uploadFile()};return(s,e)=>(u(),c("div",K,[l("form",j,[l("div",Q,[l("input",{type:"file",ref_key:"fileInput",ref:h,disabled:E(i).progress>-1&&E(i).progress<100,onChange:n},null,40,G),l("div",Z,[E(i).file?(u(),c("button",{key:0,type:"button",disabled:!E(i).file||E(i).progress>-1&&E(i).progress<100,onClick:e[0]||(e[0]=B=>F())}," Upload ",8,$)):f("",!0),E(t)?(u(),c("button",{key:1,type:"button",class:"secondary",onClick:A},"Abort")):f("",!0)])]),E(i).progress>-1&&E(i).progress<100?(u(),c("progress",{key:0,value:E(i).progress,max:"100"},null,8,J)):f("",!0),m(M,{ref_key:"inlineMessage",ref:a},null,512),l("article",null,"Progress handler invoked "+N(E(i).invocations)+" times",1),e[1]||(e[1]=l("article",{class:"pico-background-amber-50"},[l("p",null,[b(" The form will POST to https://httpbin.org/anything."),l("br"),b(" ðŸš¨ "),l("b",null,"Do not upload anything sensitive."),l("br")]),l("p",null,"Tip: if the upload happens too fast, you can throttle the upload in the browser's devtools.")],-1))])]))}}),as=JSON.parse('{"title":"","description":"","frontmatter":{},"headers":[],"relativePath":"demos/file-upload/index.md","filePath":"demos/file-upload/index.md"}'),z={name:"demos/file-upload/index.md"},ns=Object.assign(z,{setup(y){return(h,a)=>{const t=R("ClientOnly");return u(),c("div",null,[a[0]||(a[0]=l("h2",{id:"demo-file-upload",tabindex:"-1"},[b("DEMO: File Upload "),l("a",{class:"header-anchor",href:"#demo-file-upload","aria-label":'Permalink to "DEMO: File Upload"'},"â€‹")],-1)),a[1]||(a[1]=l("p",null,"This demo shows how to upload a file using APIHive and tracking it's progress.",-1)),m(t,null,{default:S(()=>[m(W)]),_:1}),a[2]||(a[2]=O("",2))])}}});export{as as __pageData,ns as default};
